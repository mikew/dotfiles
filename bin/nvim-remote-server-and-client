#!/usr/bin/env bash
set -ex

SERVER="$1"
shift
DIR="$1"
shift

SOCKET_PATH="/tmp/nvim-socket-$(date +%s)"

UNAME=$(uname -s)
NVIM_FORCE_OS=linux
if [ "$UNAME" = "Darwin" ]; then
  NVIM_FORCE_OS=macos
elif [[ "$UNAME" = MINGW* ]]; then
  NVIM_FORCE_OS=linux
fi

echo "cd '$DIR' && NVIM_FORCE_OS=$NVIM_FORCE_OS NVIM_FORCE_UI=neovide nvim --headless --listen '$SOCKET_PATH'" | ssh -L "$SOCKET_PATH:$SOCKET_PATH" "$SERVER" '$SHELL -i' &

while true; do
  if [ -S "$SOCKET_PATH" ]; then
    break
  fi

  sleep 1
done

NEOVIDE=neovide
if [ "$UNAME" = "Darwin" ]; then
  NEOVIDE=/Applications/Neovide.app/Contents/MacOS/neovide
fi

"$NEOVIDE" --server "$SOCKET_PATH" "$@"
