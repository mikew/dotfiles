#!/usr/bin/env bash
set -ex

SERVER="$1"
shift
DIR="$1"
shift

SOCKET_PATH="/tmp/nvim-socket-$(date +%s)"

echo "cd '$DIR' && NVIM_FORCE_OS=linux NVIM_FORCE_UI=neovide nvim --headless --listen '$SOCKET_PATH'" | ssh "$SERVER" '$SHELL -i' &

ssh -L "$SOCKET_PATH:$SOCKET_PATH" "$SERVER" -N &
while true; do
  if [ -S "$SOCKET_PATH" ]; then
    break
  fi

  sleep 1
done

#/Applications/Neovide.app/Contents/MacOS/neovide --server "$SOCKET_PATH" "$@"
neovide --server "$SOCKET_PATH" "$@"
